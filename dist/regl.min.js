(function(E,f){"object"===typeof exports&&"undefined"!==typeof module?f():"function"===typeof define&&define.amd?define(f):f()})(this,function(){function E(c,f){for(var q=0;q<c.length;++q)if(c[q]===f)return q;return-1}var f=require("./lib/util/check"),B=require("./lib/util/extend"),t=require("./lib/dynamic"),G=require("./lib/util/raf"),Q=require("./lib/util/clock"),ea=require("./lib/strings"),fa=require("./lib/webgl"),ga=require("./lib/extension"),ha=require("./lib/limits"),ia=require("./lib/buffer"),
ja=require("./lib/elements"),ka=require("./lib/texture"),la=require("./lib/renderbuffer"),ma=require("./lib/framebuffer"),na=require("./lib/attribute"),oa=require("./lib/shader"),pa=require("./lib/read"),qa=require("./lib/core"),ra=require("./lib/stats"),sa=require("./lib/timer");module.exports=function(c){function F(){if(0===e.length)g&&g.update(),u=null;else{u=G.next(F);R();for(var a=e.length-1;0<=a;--a){var d=e[a];d&&d(h,null,0)}b.flush();g&&g.update()}}function q(){!u&&0<e.length&&(u=G.next(F))}
function H(){u&&(G.cancel(F),u=null)}function S(a){a.preventDefault();I=!0;H();T.forEach(function(a){a()})}function U(a){b.getError();I=!1;J.restore();K.restore();v.restore();w.restore();C.restore();r.restore();y.restore();g&&g.restore();p.procs.refresh();q();V.forEach(function(a){a()})}function L(a){function d(a){var d={},W={};Object.keys(a).forEach(function(b){var k=a[b];t.isDynamic(k)?W[b]=t.unbox(k,b):d[b]=k});return{dynamic:W,"static":d}}function b(a){for(;n.length<a;)n.push(null);return n}f(!!a,
"invalid args to regl({...})");f.type(a,"object","invalid args to regl({...})");var z=d(a.context||{}),c=d(a.uniforms||{}),e=d(a.attributes||{}),g=d(function(a){function d(a){if(a in b){var k=b[a];delete b[a];Object.keys(k).forEach(function(d){b[a+"."+d]=k[d]})}}var b=B({},a);delete b.uniforms;delete b.attributes;delete b.context;delete b.vao;"stencil"in b&&b.stencil.op&&(b.stencil.opBack=b.stencil.opFront=b.stencil.op,delete b.stencil.op);d("blend");d("depth");d("cull");d("stencil");d("polygonOffset");
d("scissor");d("sample");"vao"in a&&(b.vao=a.vao);return b}(a));a={gpuTime:0,cpuTime:0,count:0};var z=p.compile(g,e,c,z,a),h=z.draw,m=z.batch,l=z.scope,n=[];return B(function(a,d){var c;I&&f.raise("context lost");if("function"===typeof a)return l.call(this,null,a,0);if("function"===typeof d)if("number"===typeof a)for(c=0;c<a;++c)l.call(this,null,d,c);else if(Array.isArray(a))for(c=0;c<a.length;++c)l.call(this,a[c],d,c);else return l.call(this,a,d,0);else if("number"===typeof a){if(0<a)return m.call(this,
b(a|0),a|0)}else if(Array.isArray(a)){if(a.length)return m.call(this,a,a.length)}else return h.call(this,a)},{stats:a})}function M(a,d){var k=0;p.procs.poll();var c=d.color;c&&(b.clearColor(+c[0]||0,+c[1]||0,+c[2]||0,+c[3]||0),k|=16384);"depth"in d&&(b.clearDepth(+d.depth),k|=256);"stencil"in d&&(b.clearStencil(d.stencil|0),k|=1024);f(!!k,"called regl.clear with no buffer specified");b.clear(k)}function X(a){f.type(a,"function","regl.frame() callback must be a function");e.push(a);q();return{cancel:function(){function b(){var a=
E(e,b);e[a]=e[e.length-1];--e.length;0>=e.length&&H()}var c=E(e,a);f(0<=c,"cannot cancel a frame twice");e[c]=b}}}function Y(){var a=Z.viewport,d=Z.scissor_box;a[0]=a[1]=d[0]=d[1]=0;h.viewportWidth=h.framebufferWidth=h.drawingBufferWidth=a[2]=d[2]=b.drawingBufferWidth;h.viewportHeight=h.framebufferHeight=h.drawingBufferHeight=a[3]=d[3]=b.drawingBufferHeight}function R(){h.tick+=1;h.time=aa();Y();p.procs.poll()}function ba(){Y();p.procs.refresh();g&&g.update()}function aa(){return(Q()-ta)/1E3}c=fa(c);
if(!c)return null;var b=c.gl,A=b.getContextAttributes(),I=b.isContextLost(),J=ga(b,c);if(!J)return null;var D=ea(),l=ra(),m=J.extensions,g=sa(b,m),ta=Q(),N=b.drawingBufferWidth,O=b.drawingBufferHeight,h={tick:0,time:0,viewportWidth:N,viewportHeight:O,framebufferWidth:N,framebufferHeight:O,drawingBufferWidth:N,drawingBufferHeight:O,pixelRatio:c.pixelRatio},n=ha(b,m),v=ia(b,l,c,function(a){return y.destroyBuffer(a)}),y=na(b,m,n,l,v),P=ja(b,m,v,l),K=oa(b,D,l,c),w=ka(b,m,n,function(){p.procs.poll()},
h,l,c),C=la(b,m,n,l,c),r=ma(b,m,n,w,C,l),p=qa(b,D,m,n,v,P,w,r,{},y,K,{elements:null,primitive:4,count:-1,offset:0,instances:-1},h,g,c),D=pa(b,r,p.procs.poll,h,A,m,n),Z=p.next,x=b.canvas,e=[],T=[],V=[],ca=[c.onDestroy],u=null;x&&(x.addEventListener("webglcontextlost",S,!1),x.addEventListener("webglcontextrestored",U,!1));var da=r.setFBO=L({framebuffer:t.define.call(null,1,"framebuffer")});ba();A=B(L,{clear:function(a){f("object"===typeof a&&a,"regl.clear() takes an object as input");if("framebuffer"in
a)if(a.framebuffer&&"framebufferCube"===a.framebuffer_reglType)for(var b=0;6>b;++b)da(B({framebuffer:a.framebuffer.faces[b]},a),M);else da(a,M);else M(null,a)},prop:t.define.bind(null,1),context:t.define.bind(null,2),"this":t.define.bind(null,3),draw:L({}),buffer:function(a){return v.create(a,34962,!1,!1)},elements:function(a){return P.create(a,!1)},texture:w.create2D,cube:w.createCube,renderbuffer:C.create,framebuffer:r.create,framebufferCube:r.createCube,vao:y.createVAO,attributes:A,frame:X,on:function(a,
b){f.type(b,"function","listener callback must be a function");var c;switch(a){case "frame":return X(b);case "lost":c=T;break;case "restore":c=V;break;case "destroy":c=ca;break;default:f.raise("invalid event, must be one of frame,lost,restore,destroy")}c.push(b);return{cancel:function(){for(var a=0;a<c.length;++a)if(c[a]===b){c[a]=c[c.length-1];c.pop();break}}}},limits:n,hasExtension:function(a){return 0<=n.extensions.indexOf(a.toLowerCase())},read:D,destroy:function(){e.length=0;H();x&&(x.removeEventListener("webglcontextlost",
S),x.removeEventListener("webglcontextrestored",U));K.clear();r.clear();C.clear();w.clear();P.clear();v.clear();y.clear();g&&g.clear();ca.forEach(function(a){a()})},_gl:b,_refresh:ba,poll:function(){R();g&&g.update()},now:aa,stats:l});c.onDone(null,A);return A}});
