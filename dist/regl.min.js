(function(E,f){"object"===typeof exports&&"undefined"!==typeof module?f():"function"===typeof define&&define.amd?define(f):f()})(this,function(){function E(c,f){for(var m=0;m<c.length;++m)if(c[m]===f)return m;return-1}var f=require("./lib/util/check"),C=require("./lib/util/extend"),u=require("./lib/dynamic"),G=require("./lib/util/raf"),P=require("./lib/util/clock"),ca=require("./lib/strings"),da=require("./lib/webgl"),ea=require("./lib/extension"),fa=require("./lib/limits"),ga=require("./lib/buffer"),
ha=require("./lib/elements"),ia=require("./lib/texture"),ja=require("./lib/renderbuffer"),ka=require("./lib/framebuffer"),la=require("./lib/attribute"),ma=require("./lib/shader"),na=require("./lib/read"),oa=require("./lib/core"),pa=require("./lib/stats"),qa=require("./lib/timer");module.exports=function(c){function F(){if(0===e.length)g&&g.update(),v=null;else{v=G.next(F);Q();for(var a=e.length-1;0<=a;--a){var d=e[a];d&&d(h,null,0)}b.flush();g&&g.update()}}function m(){!v&&0<e.length&&(v=G.next(F))}
function H(){v&&(G.cancel(F),v=null)}function R(a){a.preventDefault();I=!0;H();S.forEach(function(a){a()})}function T(a){b.getError();I=!1;J.restore();K.restore();z.restore();w.restore();D.restore();q.restore();g&&g.restore();p.procs.refresh();m();U.forEach(function(a){a()})}function L(a){function d(a){var d={},b={};Object.keys(a).forEach(function(r){var c=a[r];u.isDynamic(c)?b[r]=u.unbox(c,r):d[r]=c});return{dynamic:b,"static":d}}function b(a){for(;m.length<a;)m.push(null);return m}f(!!a,"invalid args to regl({...})");
f.type(a,"object","invalid args to regl({...})");var n=d(a.context||{}),c=d(a.uniforms||{}),e=d(a.attributes||{}),g=d(function(a){function d(a){if(a in b){var r=b[a];delete b[a];Object.keys(r).forEach(function(d){b[a+"."+d]=r[d]})}}var b=C({},a);delete b.uniforms;delete b.attributes;delete b.context;"stencil"in b&&b.stencil.op&&(b.stencil.opBack=b.stencil.opFront=b.stencil.op,delete b.stencil.op);d("blend");d("depth");d("cull");d("stencil");d("polygonOffset");d("scissor");d("sample");return b}(a));
a={gpuTime:0,cpuTime:0,count:0};var n=p.compile(g,e,c,n,a),h=n.draw,l=n.batch,k=n.scope,m=[];return C(function(a,d){var c;I&&f.raise("context lost");if("function"===typeof a)return k.call(this,null,a,0);if("function"===typeof d)if("number"===typeof a)for(c=0;c<a;++c)k.call(this,null,d,c);else if(Array.isArray(a))for(c=0;c<a.length;++c)k.call(this,a[c],d,c);else return k.call(this,a,d,0);else if("number"===typeof a){if(0<a)return l.call(this,b(a|0),a|0)}else if(Array.isArray(a)){if(a.length)return l.call(this,
a,a.length)}else return h.call(this,a)},{stats:a})}function M(a,d){var c=0;p.procs.poll();var n=d.color;n&&(b.clearColor(+n[0]||0,+n[1]||0,+n[2]||0,+n[3]||0),c|=16384);"depth"in d&&(b.clearDepth(+d.depth),c|=256);"stencil"in d&&(b.clearStencil(d.stencil|0),c|=1024);f(!!c,"called regl.clear with no buffer specified");b.clear(c)}function V(a){f.type(a,"function","regl.frame() callback must be a function");e.push(a);m();return{cancel:function(){function d(){var a=E(e,d);e[a]=e[e.length-1];--e.length;
0>=e.length&&H()}var b=E(e,a);f(0<=b,"cannot cancel a frame twice");e[b]=d}}}function W(){var a=X.viewport,d=X.scissor_box;a[0]=a[1]=d[0]=d[1]=0;h.viewportWidth=h.framebufferWidth=h.drawingBufferWidth=a[2]=d[2]=b.drawingBufferWidth;h.viewportHeight=h.framebufferHeight=h.drawingBufferHeight=a[3]=d[3]=b.drawingBufferHeight}function Q(){h.tick+=1;h.time=Y();W();p.procs.poll()}function Z(){W();p.procs.refresh();g&&g.update()}function Y(){return(P()-ra)/1E3}c=da(c);if(!c)return null;var b=c.gl,A=b.getContextAttributes(),
I=b.isContextLost(),J=ea(b,c);if(!J)return null;var B=ca(),t=pa(),l=J.extensions,g=qa(b,l),ra=P(),x=b.drawingBufferWidth,N=b.drawingBufferHeight,h={tick:0,time:0,viewportWidth:x,viewportHeight:N,framebufferWidth:x,framebufferHeight:N,drawingBufferWidth:x,drawingBufferHeight:N,pixelRatio:c.pixelRatio},k=fa(b,l),x=la(b,l,k,B),z=ga(b,t,c,x),O=ha(b,l,z,t),K=ma(b,B,t,c),w=ia(b,l,k,function(){p.procs.poll()},h,t,c),D=ja(b,l,k,t,c),q=ka(b,l,k,w,D,t),p=oa(b,B,l,k,z,O,w,q,{},x,K,{elements:null,primitive:4,
count:-1,offset:0,instances:-1},h,g,c),B=na(b,q,p.procs.poll,h,A,l,k),X=p.next,y=b.canvas,e=[],S=[],U=[],aa=[c.onDestroy],v=null;y&&(y.addEventListener("webglcontextlost",R,!1),y.addEventListener("webglcontextrestored",T,!1));var ba=q.setFBO=L({framebuffer:u.define.call(null,1,"framebuffer")});Z();A=C(L,{clear:function(a){f("object"===typeof a&&a,"regl.clear() takes an object as input");if("framebuffer"in a)if(a.framebuffer&&"framebufferCube"===a.framebuffer_reglType)for(var b=0;6>b;++b)ba(C({framebuffer:a.framebuffer.faces[b]},
a),M);else ba(a,M);else M(null,a)},prop:u.define.bind(null,1),context:u.define.bind(null,2),"this":u.define.bind(null,3),draw:L({}),buffer:function(a){return z.create(a,34962,!1,!1)},elements:function(a){return O.create(a,!1)},texture:w.create2D,cube:w.createCube,renderbuffer:D.create,framebuffer:q.create,framebufferCube:q.createCube,attributes:A,frame:V,on:function(a,b){f.type(b,"function","listener callback must be a function");var c;switch(a){case "frame":return V(b);case "lost":c=S;break;case "restore":c=
U;break;case "destroy":c=aa;break;default:f.raise("invalid event, must be one of frame,lost,restore,destroy")}c.push(b);return{cancel:function(){for(var a=0;a<c.length;++a)if(c[a]===b){c[a]=c[c.length-1];c.pop();break}}}},limits:k,hasExtension:function(a){return 0<=k.extensions.indexOf(a.toLowerCase())},read:B,destroy:function(){e.length=0;H();y&&(y.removeEventListener("webglcontextlost",R),y.removeEventListener("webglcontextrestored",T));K.clear();q.clear();D.clear();w.clear();O.clear();z.clear();
g&&g.clear();aa.forEach(function(a){a()})},_gl:b,_refresh:Z,poll:function(){Q();g&&g.update()},now:Y,stats:t});c.onDone(null,A);return A}});
